name: COS-THETA CI/CD Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'services/**'
      - 'docker/**'
      - '.github/workflows/deploy.yml'

# =========================
# JOB 1 — DETECT CHANGES
# =========================
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend_app: ${{ steps.filter.outputs.frontend_app }}
      frontend_home: ${{ steps.filter.outputs.frontend_home }}
      user: ${{ steps.filter.outputs.user }}
      core: ${{ steps.filter.outputs.core }}
      socket: ${{ steps.filter.outputs.socket }}
      notification: ${{ steps.filter.outputs.notification }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend_app:
              - 'frontend/app/**'
            frontend_home:
              - 'frontend/home/**'
            user:
              - 'services/user/**'
            core:
              - 'services/core/**'
            socket:
              - 'services/socket/**'
            notification:
              - 'services/notification/**'

# =========================
# JOB 2 — BUILD & DEPLOY
# =========================
  deploy:
    needs: changes
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      IMAGE_TAG: latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------
      # AWS AUTH
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # -------------------------
      # FRONTEND BUILDS
      # -------------------------
      - name: Build & Push frontend-app
        if: needs.changes.outputs.frontend_app == 'true'
        run: |
          docker build -t frontend-app:latest ./frontend/app
          docker tag frontend-app:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/frontend-app:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/frontend-app:${{ env.IMAGE_TAG }}

      - name: Build & Push frontend-home
        if: needs.changes.outputs.frontend_home == 'true'
        run: |
          docker build -t frontend-home:latest ./frontend/home
          docker tag frontend-home:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/frontend-home:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/frontend-home:${{ env.IMAGE_TAG }}

      # -------------------------
      # BACKEND BUILDS
      # -------------------------
      - name: Build & Push user-service
        if: needs.changes.outputs.user == 'true'
        run: |
          docker build -t user-service:latest ./services/user
          docker tag user-service:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/user-service:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/user-service:${{ env.IMAGE_TAG }}

      - name: Build & Push core-service
        if: needs.changes.outputs.core == 'true'
        run: |
          docker build -t core-service:latest ./services/core
          docker tag core-service:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/core-service:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/core-service:${{ env.IMAGE_TAG }}

      - name: Build & Push socket-service
        if: needs.changes.outputs.socket == 'true'
        run: |
          docker build -t socket-service:latest ./services/socket
          docker tag socket-service:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/socket-service:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/socket-service:${{ env.IMAGE_TAG }}

      - name: Build & Push notification-service
        if: needs.changes.outputs.notification == 'true'
        run: |
          docker build -t notification-service:latest ./services/notification
          docker tag notification-service:latest \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/notification-service:${{ env.IMAGE_TAG }}
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/cos-theta/notification-service:${{ env.IMAGE_TAG }}

      # -------------------------
      # DEPLOY ON EC2 (SSM)
      # -------------------------
      - name: Deploy updated services on EC2
        run: |
          SERVICES=""
          if [ "${{ needs.changes.outputs.frontend_app }}" = "true" ]; then SERVICES="$SERVICES frontend-app"; fi
          if [ "${{ needs.changes.outputs.frontend_home }}" = "true" ]; then SERVICES="$SERVICES frontend-home"; fi
          if [ "${{ needs.changes.outputs.user }}" = "true" ]; then SERVICES="$SERVICES user-service"; fi
          if [ "${{ needs.changes.outputs.core }}" = "true" ]; then SERVICES="$SERVICES core-service"; fi
          if [ "${{ needs.changes.outputs.socket }}" = "true" ]; then SERVICES="$SERVICES socket-service"; fi
          if [ "${{ needs.changes.outputs.notification }}" = "true" ]; then SERVICES="$SERVICES notification-service"; fi

          echo "Deploying services: $SERVICES"

          aws ssm send-command \
            --instance-ids ${{ secrets.AWS_EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --region ${{ env.AWS_REGION }} \
            --parameters commands="[
              \"cd /home/ubuntu/cos-theta/docker\",
              \"aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com\",
              \"docker compose --env-file docker.env pull $SERVICES\",
              \"docker compose --env-file docker.env up -d --no-deps --force-recreate $SERVICES\",
              \"docker system prune -af\",
              \"docker compose restart nginx\"
            ]"
